trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  appName: 'motoblu556496'
  acrName: 'acrrm556496'
  acrLoginServer: 'acrrm556496.azurecr.io'
  imageRepository: 'motoblu'
  dockerfilePath: 'Dockerfile'
  tag: 'latest'
  resourceGroup: 'rg_sprint'
  containerGroup: 'aci-motoblu'
  location: 'brazilsouth'

stages:

  - stage: Build
    displayName: 'Build and Push Image to ACR'
    jobs:
      - job: BuildAndPush
        displayName: 'üî® Build and Push Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build and Push Docker Image to ACR'
            inputs:
              containerRegistry: 'SC-FIAP-556496'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              tags: |
                $(tag)

  - stage: Deploy
    displayName: 'Deploy Image to Azure Container Instance (ACI)'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployToACI
        displayName: 'üöÄ Deploy to Azure ACI'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy to Azure Container Instance'
            inputs:
              azureSubscription: 'SC-AZURE-RM-556496'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üîπ Iniciando deploy no Azure Container Instance..."

                az acr login --name $(acrName)

                az container delete \
                  --resource-group $(resourceGroup) \
                  --name $(containerGroup) \
                  --yes || true

                echo "üîπ Criando novo container..."
                az container create \
                  --resource-group $(resourceGroup) \
                  --name $(containerGroup) \
                  --image $(acrLoginServer)/$(imageRepository):$(tag) \
                  --os-type Linux \
                  --cpu 1 \
                  --memory 1.5 \
                  --registry-login-server $(acrLoginServer) \
                  --registry-username $(ACR_USERNAME) \
                  --registry-password $(ACR_PASSWORD) \
                  --dns-name-label $(appName) \
                  --restart-policy Always \
                  --ports 8080 \
                  --environment-variables \
                      DB_HOST="mysqlmotoblu556496.mysql.database.azure.com" \
                      DB_NAME="motoblu" \
                      DB_USER="motoblu@mysqlmotoblu556496" \
                      DB_PASS="$(DB_PASS)" \
                      GITHUB_CLIENT_ID="$(GITHUB_CLIENT_ID)" \
                      GITHUB_CLIENT_SECRET="$(GITHUB_CLIENT_SECRET)" \
                  --location $(location)

                echo "‚úÖ Deploy conclu√≠do!"
                echo "üåê Acesse em: http://$(appName).$(location).azurecontainer.io:8080"
