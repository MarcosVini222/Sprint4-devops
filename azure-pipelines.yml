trigger:
  branches:
    include:
      - main
      - master    # Dispara automaticamente quando h√° push em main/master

pool:
  vmImage: 'ubuntu-latest'   # Agente Linux hospedado pela Microsoft

variables:
  # =========================
  # üîß VARI√ÅVEIS DE CONFIGURA√á√ÉO
  # =========================
  appName: 'motoblu556496'                   # Nome da aplica√ß√£o
  acrName: 'acrrm556496'                     # Nome do Azure Container Registry
  acrLoginServer: 'acrrm556496.azurecr.io'   # Endpoint do ACR (obtido via az acr show)
  imageRepository: '$(appName)'              # Nome do reposit√≥rio dentro do ACR
  dockerfilePath: '**/Dockerfile'            # Caminho do Dockerfile
  tag: '$(Build.BuildNumber)'                # N√∫mero do build como tag da imagem
  resourceGroup: 'rg_sprint'                 # Grupo de recursos no Azure
  containerGroup: 'aci-motoblu'              # Nome do Azure Container Instance
  location: 'brazilsouth'                    # Regi√£o do Azure

# ===============================================================
# üèóÔ∏è STAGE 1 - BUILD & PUSH (Docker ‚Üí Azure Container Registry)
# ===============================================================
stages:
  - stage: Build
    displayName: 'Build and push image to ACR'
    jobs:
      - job: BuildAndPush
        displayName: 'Docker build and push to ACR'
        steps:
          - task: Docker@2
            displayName: 'üî® Build and Push Docker Image'
            inputs:
              # üîë Service Connection do tipo "Docker Registry"
              # Deve apontar para o seu ACR (ex: SC-FIAP-556496)
              containerRegistry: 'SC-FIAP-556496'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              tags: |
                $(tag)

  # ===============================================================
  # ‚òÅÔ∏è STAGE 2 - DEPLOY (Azure Container Instance)
  # ===============================================================
  - stage: Deploy
    displayName: 'Deploy image to Azure Container Instance (ACI)'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployToACI
        displayName: 'Deploy container to Azure ACI'
        steps:
          - task: AzureCLI@2
            displayName: 'üöÄ Deploy to Azure ACI'
            inputs:
              # üîë Service Connection do tipo "Azure Resource Manager"
              azureSubscription: 'SC-AZURE-RM-556496'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üîπ Iniciando deploy da aplica√ß√£o no Azure Container Instance..."

                # Deleta o container antigo (caso j√° exista)
                az container delete \
                  --resource-group $(resourceGroup) \
                  --name $(containerGroup) \
                  --yes || true

                echo "üîπ Criando novo container com a imagem atualizada..."
                az container create \
                  --resource-group $(resourceGroup) \
                  --name $(containerGroup) \
                  --image $(acrLoginServer)/$(imageRepository):$(tag) \
                  --registry-login-server $(acrLoginServer) \
                  --registry-username $(acrUser) \
                  --registry-password $(acrPassword) \
                  --dns-name-label $(appName) \
                  --restart-policy Always \
                  --ports 8080 \
                  --location $(location)

                echo "‚úÖ Deploy conclu√≠do!"
