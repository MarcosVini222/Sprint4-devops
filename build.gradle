plugins {
    id 'java'
    id 'org.springframework.boot' version '3.4.4'
    id 'io.spring.dependency-management' version '1.1.7'

    // ‚úÖ Cobertura de testes (Jacoco)
    id 'jacoco'

    // ‚úÖ Build de imagem Docker nativo com Gradle (sem Dockerfile)
    id 'com.google.cloud.tools.jib' version '3.4.1'
}

group = 'br.com.fiap'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // ======================
    // üåê SPRING CORE
    // ======================
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'

    // ======================
    // üíæ BANCO DE DADOS (MYSQL)
    // ======================
    runtimeOnly 'com.mysql:mysql-connector-j:8.0.33'

    // ======================
    // üß¨ MIGRA√á√ÉO DE BANCO (FLYWAY)
    // ======================
    implementation 'org.flywaydb:flyway-core:10.20.1'
    implementation 'org.flywaydb:flyway-database-mysql:10.20.1'

    // ======================
    // üé® FRONTEND
    // ======================
    implementation 'org.webjars:bootstrap:5.3.3'

    // ======================
    // üß™ TESTES
    // ======================
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
    useJUnitPlatform()
    finalizedBy jacocoTestReport
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
    }
}

tasks.named('bootJar') {
    archiveFileName = 'motoblu.jar'
}

tasks.named('bootRun') {
    // ‚úÖ Permite sobrescrever vari√°veis no DevOps (ex: banco, porta etc.)
    systemProperties = System.properties
}

//
// ==============================
// üê≥ CONFIGURA√á√ÉO DO JIB (DOCKER BUILD SEM DOCKERFILE)
// ==============================
jib {
    from {
        image = 'eclipse-temurin:21-jdk'
    }
    to {
        image = 'motoblu-app' // nome da imagem gerada
        tags = ['latest']
    }
    container {
        ports = ['8080']
        jvmFlags = ['-Xms512m', '-Xmx1024m']
        environment = [
                'SPRING_PROFILES_ACTIVE': 'prod']

        mainClass = 'br.com.fiap.MotobluApplication'
    }
}
