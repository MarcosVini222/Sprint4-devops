trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  # App & Container Info
  appName: 'motoblu556496'
  acrName: 'acrfiap556496'
  acrLoginServer: 'acrfiap556496.azurecr.io'
  imageRepository: 'fiap/$(appName)'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildNumber)'

  # Azure Resources
  resourceGroup: 'rg-fiap556496'
  containerGroup: 'aci-motoblu'
  location: 'brazilsouth'
  azureServiceConnection: 'SC-FIAP-556496'  # mesmo nome do Service Connection

stages:
  # =======================
  #  STAGE 1 - BUILD & PUSH
  # =======================
  - stage: Build
    displayName: 'Build and Push Docker Image to ACR'
    jobs:
      - job: BuildAndPush
        displayName: 'Docker Build and Push'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Build and push image to Azure Container Registry'
            inputs:
              containerRegistry: '$(azureServiceConnection)'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              tags: |
                $(tag)
          
          - script: |
              echo "‚úÖ Build finalizado e imagem publicada no ACR: $(acrLoginServer)/$(imageRepository):$(tag)"
            displayName: 'Confirmar imagem publicada'

  # =======================
  #  STAGE 2 - DEPLOY TO ACI
  # =======================
  - stage: Deploy
    displayName: 'Deploy to Azure Container Instance (ACI)'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployToACI
        displayName: 'Deploy container to Azure'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Container Instance'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üöÄ Iniciando deploy da aplica√ß√£o no Azure Container Instance..."
                echo "Verificando se o container group j√° existe..."
                EXISTE=$(az container show --resource-group $(resourceGroup) --name $(containerGroup) --query "name" -o tsv || echo "nao")

                if [ "$EXISTE" != "nao" ]; then
                  echo "üåÄ Atualizando container existente: $(containerGroup)"
                  az container delete --resource-group $(resourceGroup) --name $(containerGroup) --yes
                else
                  echo "üÜï Criando novo container: $(containerGroup)"
                fi

                az container create \
                  --resource-group $(resourceGroup) \
                  --name $(containerGroup) \
                  --image $(acrLoginServer)/$(imageRepository):$(tag) \
                  --registry-login-server $(acrLoginServer) \
                  --dns-name-label $(appName)-dns \
                  --restart-policy Always \
                  --ports 8080 \
                  --location $(location) \
                  --environment-variables \
                    DB_HOST=$(DB_HOST) \
                    DB_PORT=$(DB_PORT) \
                    DB_NAME=$(DB_NAME) \
                    DB_USER=$(DB_USER) \
                    DB_PASS=$(DB_PASS)

                echo "‚úÖ Deploy conclu√≠do com sucesso!"
                echo "üåê Acesse: http://$(appName)-dns.$(location).azurecontainer.io:8080/"
